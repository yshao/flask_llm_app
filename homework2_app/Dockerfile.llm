# ============================================================================
# Dockerfile.llm - PostgreSQL with pgvector for Railway
# ============================================================================
# Standalone PostgreSQL 16 with pgvector extension for vector embeddings.
# Optimized for Railway deployment.
#
# Build: docker build -f Dockerfile.llm -t pgvector-llm .
# Run:   docker run -p 5432:5432 pgvector-llm
#
# Railway Deployment:
#   1. Create new service in Railway
#   2. Select "Dockerfile" as build type
#   3. Set dockerfilePath to "homework2_app/Dockerfile.llm"
#   4. Add environment variables:
#      POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD
# ============================================================================

FROM pgvector/pgvector:pg16

# ----------------------------------------------------------------------------
# Metadata
# ----------------------------------------------------------------------------
LABEL maintainer="Prof. MM Ghassemi <ghassem3@msu.edu>"
LABEL description="PostgreSQL 16 with pgvector extension for vector embeddings"

# ----------------------------------------------------------------------------
# Environment variables (with defaults)
# ----------------------------------------------------------------------------
ENV POSTGRES_DB=homework_db \
    POSTGRES_USER=postgres \
    POSTGRES_PASSWORD=changeme

# ----------------------------------------------------------------------------
# Copy initialization script
# ----------------------------------------------------------------------------
# This script will automatically enable the pgvector extension
# on first container start
COPY init-pgvector.sh /docker-entrypoint-initdb.d/10-init-pgvector.sh
RUN chmod +x /docker-entrypoint-initdb.d/10-init-pgvector.sh

# ----------------------------------------------------------------------------
# Expose PostgreSQL port
# ----------------------------------------------------------------------------
EXPOSE 5432

# ----------------------------------------------------------------------------
# Volume for data persistence
# ----------------------------------------------------------------------------
VOLUME ["/var/lib/postgresql/data"]

# ----------------------------------------------------------------------------
# Health check
# ----------------------------------------------------------------------------
# Railway uses health checks to determine service status
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} || exit 1

# ----------------------------------------------------------------------------
# Use default PostgreSQL entrypoint from base image
# ----------------------------------------------------------------------------
# The pgvector/pgvector:pg16 base image includes proper entrypoint
# that handles database initialization automatically
